- hosts: all
  become: yes
  tasks:
    - name: Generate an OpenSSH keypair
      community.crypto.openssh_keypair:
        path: /root/.ssh/id_ed25519
        type: ed25519

    - name: Download authorized keys
      get_url:
        url: https://github.com/maxisme.keys
        dest: /root/.ssh/authorized_keys

    - name: Disable empty password login
      lineinfile:
        dest: "/etc/ssh/sshd_config"
        regexp: '^#?PermitEmptyPasswords'
        line: 'PermitEmptyPasswords no'

    - name: Disable password login
      lineinfile:
        dest: "/etc/ssh/sshd_config"
        regexp: '^(#\s*)?PasswordAuthentication '
        line: 'PasswordAuthentication no'

    - name: Restart sshd
      service: name=sshd state=restarted

    - name: Change hostname to the inventory_hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Store new hostname in /etc/hosts
      lineinfile:
        state=present
        dest=/etc/hosts
        line="{{ ansible_default_ipv4.address }} {{ inventory_hostname }} {{ ansible_hostname }}"
        regexp="^{{ ansible_default_ipv4.address }}"

- name: Setup wireguard mesh
  hosts: all
  remote_user: root
  roles:
    - maxisme.wireguard_private_networking
  vars:
    wireguard_network_name: "private"